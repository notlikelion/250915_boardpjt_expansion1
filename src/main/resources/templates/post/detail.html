<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${post.title}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/header :: headerFragment}"></div>

<main class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a th:href="@{/posts}" class="btn btn-secondary">목록으로</a>
        <div th:if="${#authentication != null and #authentication.name == post.author.username}">
            <a th:href="@{/posts/{id}/edit(id=${post.id})}" class="btn btn-warning">수정</a>
            <form th:action="@{/posts/{id}/delete(id=${post.id})}" method="post" class="d-inline">
                <button type="submit" class="btn btn-danger">삭제</button>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h2 th:text="${post.title}"></h2>
            <div class="text-muted">
                <span>작성자: </span><span th:text="${post.author.username}"></span> |
                <span>작성일: </span><span th:text="${#temporals.format(post.createdAt, 'yyyy-MM-dd HH:mm')}"></span> |
                <span>수정일: </span><span th:text="${#temporals.format(post.updatedAt, 'yyyy-MM-dd HH:mm')}"></span>
            </div>
            <div th:if="${#authentication != null and #authentication.name != post.author.username}" class="mt-2">
                팔로잉: <span id="followingCount"></span> / 팔로워: <span id="followerCount"></span>
                <button th:unless="${followCheck}" id="followButton" class="btn btn-sm btn-info">팔로우</button>
                <button th:if="${followCheck}" id="unfollowButton" class="btn btn-sm btn-outline-info">언팔로우</button>
            </div>
        </div>
        <div class="card-body">
            <p class="card-text" style="white-space: pre-wrap;" th:text="${post.content}"></p>
        </div>
    </div>

    <div class="mt-4">
        <h3>댓글</h3>
        <div th:if="${#authentication != null and #authentication.isAuthenticated()}">
            <form id="commentForm" class="mb-3">
                <div class="input-group">
                    <textarea id="commentContent" class="form-control" placeholder="댓글을 입력하세요"></textarea>
                    <button class="btn btn-outline-primary" type="submit">작성</button>
                </div>
            </form>
        </div>
        <div id="commentList" class="list-group"></div>
    </div>
</main>

<div th:replace="~{fragments/footer :: footerFragment}"></div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const postId = /*[[${post.id}]]*/ 0;
    const authorId = /*[[${post.author.id}]]*/ 0;
    const currentUsername = /*[[${#authentication != null ? #authentication.name : null}]]*/ null;

    async function loadComments() {
        const response = await fetch(`/api/comments/${postId}`);
        if (!response.ok) return;
        const comments = await response.json();
        const commentList = document.getElementById("commentList");
        commentList.innerHTML = "";
        comments.forEach(c => {
            const item = document.createElement("div");
            item.className = "list-group-item d-flex justify-content-between align-items-center";
            item.innerHTML = `<div><strong>${c.username}</strong>: ${c.content} <small class="text-muted">(${c.createdAt})</small></div>`;

            if (c.username === currentUsername) {
                const deleteBtn = document.createElement("button");
                deleteBtn.className = "btn btn-danger btn-sm";
                deleteBtn.textContent = "삭제";
                deleteBtn.onclick = async () => {
                    await fetch(`/api/comments/${c.id}`, { method: "DELETE" });
                    loadComments();
                };
                item.appendChild(deleteBtn);
            }
            commentList.appendChild(item);
        });
    }

    const commentForm = document.getElementById("commentForm");
    if(commentForm) {
        commentForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const content = document.getElementById("commentContent").value;
            await fetch(`/api/comments/${postId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ postId, content, username: currentUsername }),
            });
            document.getElementById("commentContent").value = "";
            loadComments();
        });
    }


    async function loadCounts() {
        const [followingRes, followerRes] = await Promise.all([
            fetch(`/api/follow/${authorId}/followingCount`),
            fetch(`/api/follow/${authorId}/followerCount`)
        ]);
        document.getElementById("followingCount").textContent = await followingRes.text();
        document.getElementById("followerCount").textContent = await followerRes.text();
    }

    async function handleFollow(follow) {
        await fetch(`/api/follow/${authorId}`, { method: follow ? "POST" : "DELETE" });
        location.reload();
    }

    const followButton = document.getElementById("followButton");
    if(followButton) {
        followButton.addEventListener("click", () => handleFollow(true));
    }

    const unfollowButton = document.getElementById("unfollowButton");
    if(unfollowButton) {
        unfollowButton.addEventListener("click", () => handleFollow(false));
    }

    document.addEventListener("DOMContentLoaded", () => {
        loadComments();
        if(document.getElementById("followingCount")){
            loadCounts();
        }
    });
</script>
</body>
</html>